# 游戏开发记录

## 音效系统优化
- 添加了音效资源的自动下载功能
- 修复了PowerShell下载音频文件的问题
- 优化了子弹射击音效，现在每颗子弹都有独立的音效
- 添加了导弹发射的专门音效，调整了音量和音调
- 更换了击杀音效为explosion2.wav，优化了播放机制
- 改进了音频控制器，添加了更平滑的淡入淡出效果
- 优化了音效实例的创建和清理机制，避免内存泄漏

### 音效说明
1. 射击音效 (shoot.mp3)
   - 用于普通子弹发射
   - 音量较小，适合快速连续播放

2. 击杀音效 (explosion2.wav)
   - 用于击中并击毁敌人时的效果
   - 使用独立音效实例播放，避免重叠
   - 音量适中，提供即时反馈

3. 能量音效 (powerup.mp3)
   - 用于收集物资包时的提示音
   - 音量适中，提供正面反馈

4. 背景音乐 (background.mp3)
   - 游戏背景音乐循环播放
   - 音量较低，避免干扰游戏体验

5. 玩家受击音效 (player_hit.mp3)
   - 用于玩家被击中时的提示
   - 音量适中，提供明显的警告效果

6. BOSS死亡音效 (boss_death.mp3)
   - 用于BOSS被击败时的特效
   - 音量较大，突出重要性
   - 播放时会短暂降低背景音乐音量

### 音效优化要点
1. 使用AudioController统一管理所有音效
2. 实现了音效实例池，避免重复创建音频对象
3. 添加了音量渐变效果，使音效切换更自然
4. 优化了音效触发时机，避免重叠播放
5. 根据游戏状态（暂停/继续）自动管理音效

## 界面优化
1. 第一轮优化：
   - 调整了画布尺寸为更合适的宽度（500px）
   - 改进了信息面板的显示效果
   - 优化了暂停按钮的样式和位置
   - 增强了BOSS战提示的视觉效果

2. 第二轮优化：
   - 将画布宽度调整为400px以获得更好的游戏体验
   - 修正了暂停按钮的位置和样式
   - 更新了物资包的图片资源路径
   - 简化了游戏信息显示

3. 第三轮优化：
   - 将游戏信息面板移至屏幕顶部
   - 合并显示得分和关卡信息，使界面更紧凑
   - 优化了暂停按钮的尺寸和文字对齐方式
   - 减小了信息面板的高度，提升界面整洁度

## 物资包系统改进
1. 初始设计：
   - 实现了基础的物资包系统
   - 添加了三种不同类型的物资：医疗包、武器升级、护盾
   - 设计了物资包的基本外观

2. 视觉优化：
   - 改进了物资包的降落伞效果
   - 为不同类型的物资添加了对应的颜色主题
   - 添加了物资包的光晕效果
   - 优化了降落伞的绳索和纹理细节

3. 最新改进：
   - 恢复了降落伞吊着物资的设计
   - 调整物资包贴图为圆形显示
   - 确保物资包颜色与游戏主题保持一致
   - 优化了降落伞的视觉效果和动画

## 游戏界面简化
- 移除了难度显示
- 移除了BOSS战倒计时显示
- 保留了得分和关卡信息
- 优化了BOSS战提示的显示方式

## BOSS系统优化 (2024-xx-xx)

### 1. BOSS出现时机调整
- 将BOSS出现时间从6分钟调整为2分30秒
- 优化了BOSS的生成逻辑，确保每关只生成一次BOSS
- BOSS出现时会暂停普通敌人的生成，专注于BOSS战

### 2. BOSS移动模式优化
- 移除了BOSS的旋转效果，使其保持稳定姿态
- 限制BOSS活动范围在屏幕上方1/3区域
- 添加了状态机系统来控制BOSS行为：
  - ENTER: 入场动画状态
  - IDLE: 左右移动状态
  - ATTACK1/2/3: 三种不同的攻击状态

### 3. BOSS属性调整
- 血量从50提升至5000，增加了挑战性
- 保持了原有的血条显示系统，更直观地展示战斗进度
- 优化了BOSS的移动速度和攻击间隔

### 4. BOSS攻击系统升级
添加了三种不同的攻击模式：

1. 圆形弹幕攻击
   - 发射12颗呈圆形分布的紫色能量球
   - 子弹具有渐变效果和光晕
   - 形成环形弹幕压制玩家移动

2. 追踪导弹攻击
   - 发射3枚红色追踪导弹
   - 导弹会智能跟踪玩家位置
   - 设置了速度限制和最大追踪时间
   - 追踪失败时会进入自旋模式并消失

3. 散射攻击
   - 发射5颗呈扇形分布的子弹
   - 45度散射角覆盖范围
   - 子弹具有渐变色效果
   - 形成扇形火力覆盖区域

### 5. 技术实现细节
1. 子弹系统
   - 新增 `EnemyBullet` 类处理BOSS子弹
   - 实现了子弹碰撞检测系统
   - 添加了子弹生命周期限制
   - 优化了子弹的视觉效果

2. 状态管理
   - 使用 `BOSS_STATES` 枚举管理BOSS状态
   - 实现了状态切换逻辑
   - 优化了攻击模式的切换机制

3. 视觉效果
   - 为不同类型的子弹添加独特的视觉效果
   - 优化了BOSS的装甲和能量核心的显示效果
   - 添加了攻击特效和粒子效果

### 6. 平衡性调整
- 攻击间隔设置为120帧
- 子弹速度和伤害进行了平衡
- 设置了合理的追踪导弹参数
- 优化了弹幕分布和密度

### 7. 后续优化方向
- [ ] 可以考虑添加BOSS受伤特效
- [ ] 优化BOSS死亡动画
- [ ] 增加更多类型的攻击模式
- [ ] 添加BOSS战专属音效
- [ ] 实现BOSS血量阶段性变化机制

## 待优化项目
- 继续完善音效系统
- 进一步优化游戏平衡性
- 考虑添加新的游戏特性

## 背景系统修复 (2024-xx-xx)

### 问题描述
- 游戏背景显示为黑屏
- 控制台报错：`drawBackground is not defined`
- 游戏核心功能无法正常显示

### 修复方案
1. 重新实现背景渲染系统：
   - 添加渐变背景
   - 实现动态星空效果
   - 优化星星的视觉表现

2. 技术细节：
   - 使用 Canvas 渐变实现背景
   - 实现100颗动态星星
   - 添加星星闪烁效果
   - 优化星星移动逻辑

3. 改进效果：
   - 更流畅的背景动画
   - 更自然的星星效果
   - 更好的游戏氛围

### 后续优化方向
- [ ] 可以考虑添加远近层次的星星
- [ ] 添加星云或其他空间效果
- [ ] 优化星星的生成和更新算法
- [ ] 考虑添加背景音效增强氛围

## BOSS位置修复 (2024-07-01)

### [2024-07-01 14:30] 修复当前BOSS模型位置错误问题，固定BOSS在屏幕上方1/5的位置，我方战机被击中后闪烁2秒，这两秒内不会收到伤害

#### 问题描述
1. BOSS模型位置显示不正确
2. 需要将BOSS固定在屏幕上方1/5的位置
3. 需要实现玩家战机被击中后的无敌时间

#### 解决方案
1. 修复BOSS位置问题：
   - 重新设计了`updateBoss()`方法，确保BOSS始终保持在正确位置
   - 在每次更新时都重新计算目标Y位置（屏幕高度的1/5）
   - 在所有状态下都强制将BOSS的Y坐标设置为目标值
   - 简化了状态切换逻辑，确保BOSS在攻击后总是回到IDLE状态

2. 固定BOSS在屏幕上方1/5位置：
   - 明确设置`targetY = canvas.height / 5`
   - 在各个状态中强制BOSS保持在这个位置
   - 在ENTER状态下，只有当BOSS还没达到目标位置时才移动它

3. 实现玩家无敌状态：
   - 在`Player`类中添加了三个新属性：
     - `isInvincible`: 标记是否处于无敌状态
     - `invincibleTimer`: 计时器，用于跟踪无敌状态持续时间
     - `blinkInterval`: 用于控制闪烁效果的计数器
   - 在`draw()`方法中添加了闪烁效果逻辑
   - 在`update()`方法中添加了无敌状态更新逻辑，超过120帧（约2秒）后自动解除无敌状态
   - 修改了碰撞检测函数，在玩家处于无敌状态时不检测碰撞

### [2024-07-01 15:10] 当前BOSS位置还是不对，BOSS的攻击来自于上方的四个点中间，但是BOSS本体却出现在屏幕下方

#### 问题描述
从提供的截图可以看出，BOSS的血条正确显示在上方1/5位置，但BOSS本体却出现在屏幕下方，而攻击仍来自上方的正确位置。

#### 解决方案
修复了BOSS绘制方法中的位置偏移问题：

1. 重写了BOSS的绘制结构：
   - 之前的问题是在`drawBoss`方法中，存在多个`ctx.save()`和`ctx.restore()`调用，导致坐标系统混乱
   - 简化了结构，确保所有BOSS的组件都是相对于一个中心点绘制的

2. 修改了坐标变换逻辑：
   - 将BOSS的`draw`方法拆分，对不同类型的敌人使用不同的绘制方法
   - 对于BOSS，直接在`drawBoss`方法中设置正确的坐标变换

3. 统一了坐标系统：
   - 确保所有绘制操作都是基于BOSS的实际位置(this.x, this.y)进行的
   - 将所有的绘制操作都放在`ctx.translate`之后，确保它们相对于BOSS的中心点

这确保了BOSS的图形、血条和攻击都来自同一位置，并且固定在屏幕上方1/5处。

### [2024-07-01 15:45] 资源包出现的概率调整为武器升级包（30%），护盾（10%），血包（10%）

#### 问题描述
需要调整游戏中资源包的生成概率，使不同类型的资源包出现概率不同。

#### 解决方案
1. 修改了普通敌人掉落物资包的逻辑：
   - 总体保持30%的几率触发物资包生成
   - 在触发生成时，调整为：
     - 武器升级包: 30%概率
     - 护盾: 10%概率
     - 血包: 10%概率
     - 无物品: 50%概率

2. 为BOSS掉落创建单独的生成函数：
   - 创建了新的`spawnBossPowerUp`函数
   - BOSS死亡时保证100%生成物品，不受随机概率影响
   - BOSS掉落物品概率调整为：
     - 武器升级包: 50%概率
     - 护盾: 25%概率
     - 血包: 25%概率

3. 实现细节：
   - 使用`Math.random()`生成随机数
   - 通过概率区间判断生成哪种类型的物资包
   - 确保BOSS击杀的奖励更加丰厚和可靠

### [2024-07-01 17:00] 修正子弹的方向，使其前端为尖形、后端为平形

#### 问题描述
玩家战机的子弹方向不正确，当前子弹前面是平的，后面是尖的，与子弹的正常飞行方向不符。在游戏画面中子弹看起来是倒着飞行的。

#### 解决方案
1. 修改了`Bullet`类中普通子弹的绘制方法：
   - 移除了原来的矩形绘制代码(`fillRect`)
   - 改用路径绘制方式(`beginPath`和`closePath`)创建三角形子弹
   - 将子弹形状调整为前端(顶部)尖形，后端(底部)平形
   - 保留了子弹底部的尾焰效果

2. 绘制细节：
   - 使用三个点定义子弹形状：
     - 左下角(底部)
     - 右下角(底部)
     - 顶部中心点(尖端)
   - 保持了原有的颜色渐变效果
   - 确保尾焰在平面的底部
   
3. 视觉效果：
   - 子弹现在看起来是朝正确方向(向上)飞行
   - 形状符合弹药的空气动力学设计
   - 更加符合玩家的直觉认知

### [2024-07-01 17:30] 修改玩家与BOSS碰撞逻辑，BOSS不再一次性消失

#### 问题描述
当玩家战机撞到BOSS时，BOSS会立即消失（被销毁），这与BOSS应有的强度不符，同时也降低了游戏的挑战性。从游戏截图可以看出，玩家战机与BOSS碰撞后BOSS直接消失了。

#### 解决方案
修改了敌机与玩家的碰撞检测逻辑，针对BOSS和普通敌人区分处理：

1. BOSS碰撞特殊处理：
   - 当玩家与BOSS碰撞时，BOSS只损失50点血量，而不是直接被销毁
   - 只有当BOSS血量降至0或以下时，才会被移除并触发死亡处理
   - 保留了原有的玩家受伤机制，仍然会减少一条命并进入短暂无敌状态

2. 普通敌人碰撞处理：
   - 保持原有逻辑，碰撞后直接移除敌人
   - 玩家同样受到伤害，损失一条命

3. 实现方式：
   - 在`checkCollisions`函数中增加了敌人类型判断
   - 使用条件判断区分BOSS和普通敌人的碰撞逻辑
   - 对BOSS单独实现了扣血而非直接销毁的机制

4. 平衡性考虑：
   - 选择50点血量作为碰撞伤害，保持了合理的平衡性
   - BOSS总血量通常为1000点，意味着玩家需要多次碰撞才能击败BOSS
   - 由于碰撞会导致玩家损失生命，这种战术仍有较高风险

## 2024年7月1日 - 关卡难度系统调整

### 问题描述
1. BOSS被击败后不正确地再次出现，而不是进入第二关。
2. 游戏关卡之间难度变化不明显，缺乏进阶性挑战。

### 解决方案
1. 调整关卡系统：
   - 完善了`startNextLevel`函数，确保正确进入下一关。
   - 加入了`spawnEnemies`函数的调用，以在关卡变更时重置敌人生成计时器。

2. 增强难度系统：
   - 添加了全局控制变量：
     - `enemySpawnBaseInterval`：敌人生成的基础间隔时间（1000ms）
     - `enemySpawnInterval`：当前敌人生成间隔
     - `maxEnemies`：屏幕上同时存在的最大敌人数量
     - `enemySpeedFactor`：敌人速度系数

   - 修改了`Enemy`类构造函数，使其从原型属性读取生命值：
     - `Enemy.prototype.baseHealth`：普通敌人基础生命值
     - `Enemy.prototype.bossBaseHealth`：BOSS基础生命值

   - 完善了`increaseGameDifficulty`函数，实现多维度的难度递增：
     - 敌人生命值：每关增加20%
     - BOSS生命值：从1000开始，每关增加20%
     - 敌人生成速度：每关减少生成间隔
     - 敌人移动速度：每关增加15%
     - 敌人最大数量：每关增加，上限为15个

3. 优化敌人生成逻辑：
   - 添加了对敌人最大数量的检查，避免屏幕敌人过多。
   - 每关增加了快速敌机的生成概率。

### 实现效果
- 现在游戏在关卡提升时难度会显著增加，为玩家带来明显的挑战递进感。
- BOSS战后能够正确过渡到下一关卡。
- 随着关卡提升，敌人变得更多、更快、更强，但玩家击杀敌人获得的装备也相应提升，保持游戏平衡。

### 代码实现
主要修改了以下几个关键部分：
1. 添加了全局变量控制游戏难度参数
2. 修改了Enemy类的构造函数和getSpeed方法
3. 完善了increaseGameDifficulty和startNextLevel函数的逻辑

这些修改使游戏的难度系统更加完善，提供了更好的游戏体验和挑战性。

### [2024-07-01 19:15] 优化导弹视觉效果，修复导弹无目标时的方向问题

#### 问题描述
1. 导弹的颜色设计存在问题，主体和尾焰颜色太过相似（橙红色系），缺乏视觉对比度。
2. 导弹在没有找到敌方目标时，显示为横向状态而非竖直向上飞行，视觉效果不自然。

#### 解决方案
1. 重新设计导弹的颜色方案：
   - 将导弹主体颜色从橙红色系改为蓝色系：
     - 主体渐变使用 `#0066cc`、`#4488dd` 和 `#0044aa` 的蓝色组合
     - 导弹翼使用更深的蓝色 `#0055bb`
   - 保留尾焰的橙红色调，形成鲜明对比：
     - 尾焰保持原有的 `#ff4400` 和 `#ff8800` 色调
     - 尾焰尖端渐变至透明黄色

2. 修改导弹的光晕效果：
   - 将光晕颜色从橙色改为蓝色 `#66aaff`
   - 光晕填充色调整为半透明的蓝色 `rgba(50, 150, 255, 0.2)`

3. 修复导弹无目标时的方向问题：
   - 移除了被注释掉的旋转角度设置代码
   - 重新启用 `this.rotationAngle = -Math.PI/2` 设置，确保导弹始终保持垂直向上的姿态

#### 实现效果
- 导弹视觉效果更加清晰，主体与尾焰形成蓝色与橙色的鲜明对比
- 无目标导弹保持垂直向上飞行，符合直觉预期
- 整体视觉效果更加美观和专业，提升了游戏品质感

- [2024-04-05 08:45] 用户提问的问题：击败第一关boss后出错了 (报错：`ReferenceError: showLevelIndicator is not defined`)
- 解决方法：
  1. 在 `index.html` 中添加了 `<div id="levelIndicator">` 用于显示关卡提示。
  2. 在 `script.js` 中定义了 `showLevelIndicator` 和 `hideLevelIndicator` 函数，并在 `startNextLevel` 和 `resetGame` 中调用，修复了引用错误并实现了关卡切换提示功能。

- [2024-04-05 08:55] 用户提问的问题：优化游戏难度增加速度和方式，修正导弹初始方向
- 解决方法：
  1. 修改 `increaseGameDifficulty` 函数，将每关基础难度增量从 15% 提高到 25%。
  2. 修改 `Enemy` 构造函数，实现关卡内难度因子在 Boss 出现前从 1.0 线性增长到 1.5。
  3. 修改 `Bullet` 构造函数，为导弹类型设置初始 `rotationAngle = -Math.PI / 2`，使其初始指向正确。
  4. (额外修复)修正了 `Enemy` 构造函数中 `bossBaseHealth` 的错误值 (从 100 改回 1000)。

- [2024-04-05 09:15] 用户提问的问题：优化武器系统，包括导弹对称发射、新增斜向子弹、实现新的13级武器升级策略及后续射速提升。
- 解决方法：
  1. 修改 `Player.createMissiles`，根据传入的 `missileCount` 计算对称的起始位置 `startX`，确保导弹围绕玩家中心对称发射。
  2. 在 `Bullet` 类构造函数中添加 `angle` 参数，并在 `update` 方法中根据角度移动普通子弹；同时修正了绘制时的旋转角度计算。
  3. 添加 `Player.createDiagonalBullets` 方法，用于根据 `countPerSide` 生成指定角度（+/- PI/8）的斜向子弹。
  4. 重写 `Player.shoot` 方法，根据 `gameState.weaponLevel` (1-12+) 决定 `normalBulletCount`, `missileCount`, `diagonalBulletCountPerSide` 的具体数值。
  5. 修改 `PowerUp.applyEffect` 中处理 'weapon' 的逻辑：等级在 12 级前正常增加；达到 12 级后，等级不再显示提升（但内部仍然增加用于计算），开始提升射速（降低 `normalShootingSpeed` 和 `missileShootingSpeed`），射速提升有上限（最多降低基础间隔的 25%）。
  6. (额外修复) 调整了 `Bullet.update` 中导弹丢失目标后的直线飞行逻辑和追踪逻辑；调整了 `EnemyBullet` 的追踪逻辑；调整了 `Enemy` 绘制和 `Boss` 攻击逻辑；完善了 `resetGame`。

- [2024-04-05 09:25] 用户提问的问题：BOSS本体和血条位置不匹配，子弹发射位置也与模型不同。
- 解决方法：重构 `Enemy.draw()` 和 `Enemy.drawBoss()` 方法。将坐标变换（`ctx.translate`）统一放在 `Enemy.draw()` 中处理。移除 `Enemy.drawBoss()` 内部多余的坐标变换，使其绘制操作基于已经变换好的坐标系（相对0,0点绘制），从而修复双重位移导致的绘制位置错误。
